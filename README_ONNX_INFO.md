# Информация об ONNX моделях в проекте

## Модель `model.onnx`

**Расположение:** `Assets/Models/model.onnx`

**Размер:** 14 МБ

**Входные данные:**
- `pixel_values`: tensor(float), форма: ['batch_size', 'num_channels', 'height', 'width']
  - batch_size: по умолчанию 1
  - num_channels: 3 (RGB) - **несоответствие с WallSegmentation.cs, где указано 32 канала**
  - height: динамическая (32 в WallSegmentation.cs)
  - width: динамическая (32 в WallSegmentation.cs)

**Выходные данные:**
- `logits`: tensor(float), форма: ['batch_size', 'num_labels', 'height', 'width']
  - batch_size: 1
  - num_labels: 150 (количество классов) - **несоответствие с WallSegmentation.cs, класс стены с индексом 9 занимает 67-е место по активации**
  - height: 8 (downsample от входных данных в 4 раза)
  - width: 8 (downsample от входных данных в 4 раза)

**Анализ классов:**
- **Топ-5 наиболее активных классов:**
  1. Класс 0: -1.787982
  2. Класс 3: -3.830821
  3. Класс 76: -4.894038
  4. Класс 22: -4.949096
  5. Класс 14: -4.997285
- **Предполагаемый класс стены (9):** -7.863040 (67-е место из 150)

**Производитель:** pytorch

**Наименование графа:** torch_jit

## Модель `BiseNet.onnx`

**Расположение:** 
- `Assets/Models/BiseNet.onnx`
- `Assets/StreamingAssets/BiseNet.onnx` (дублирующая копия)

**Размер:** 46 МБ

**Входные данные:**
- `image`: tensor(float), форма: [1, 3, 720, 960] - **имя тензора отличается от указанного в WallSegmentation.cs (pixel_values)**
  - фиксированный размер батча (1)
  - 3 канала (RGB)
  - фиксированная высота (720)
  - фиксированная ширина (960)

**Выходные данные:**
- `predict`: tensor(float), форма: [1, 12, 720, 960] - **имя тензора отличается от указанного в WallSegmentation.cs (logits)**
  - batch_size: 1
  - num_labels: 12 (12 классов сегментации) - **класс с индексом 9 входит в топ-3 активных классов**
  - height: 720 (соответствует входным данным)
  - width: 960 (соответствует входным данным)

**Анализ классов:**
- **Топ-5 наиболее активных классов:**
  1. Класс 1: 17.014568
  2. Класс 11: 5.530399
  3. **Класс 9: 5.429779**
  4. Класс 2: 2.258374
  5. Класс 4: 0.472372
- **Предполагаемый класс стены (9):** 5.429779 (3-е место из 12)

**Производитель:** pytorch

**Наименование графа:** main_graph

## Выявленные несоответствия

В файле `WallSegmentation.cs` указаны следующие параметры:
- Имя входного тензора: `pixel_values` - **соответствует только модели model.onnx**
- Имя выходного тензора: `logits` - **соответствует только модели model.onnx**
- Размер входной модели: 32x32 пикселя - **сильно меньше чем 720x960 в BiseNet.onnx**
- Количество входных каналов: 32 - **не соответствует 3 каналам RGB в обеих моделях**
- Индекс класса "стена": 9 - **правильно только для BiseNet.onnx (3-е место по активации), но неправильно для model.onnx (67-е место)**

## Заключение

Анализ показывает, что **BiseNet.onnx** более подходит для сегментации стен, так как:
1. Класс с индексом 9 имеет высокую активацию (3-е место из 12 классов)
2. Значения активации для класса 9 положительные (5.43), что указывает на уверенное определение
3. Модель выдает полноразмерную сегментацию (720x960)

Однако имена тензоров (`image`/`predict`) не соответствуют тем, что используются в WallSegmentation.cs (`pixel_values`/`logits`), что требует исправления.

## Рекомендации по исправлению

1. Привести в соответствие количество каналов в WallSegmentation.cs (изменить с 32 на 3)
2. Если используется model.onnx, выбрать другой индекс класса для стен (возможно, 0 или 3)
3. Если используется BiseNet.onnx, обновить имена тензоров на `image` и `predict`
4. Привести в соответствие размеры входного изображения с требованиями модели
5. Рассмотреть вариант перехода на BiseNet.onnx для более качественного определения стен

## Результаты тестового запуска

### Модель `model.onnx`:
- Статистика выхода:
  - Минимум: -14.07
  - Максимум: -1.57
  - Среднее: -8.14
  - Стандартное отклонение: 1.84

### Модель `BiseNet.onnx`:
- Статистика выхода:
  - Минимум: -14.04
  - Максимум: 19.48
  - Среднее: 0.69
  - Стандартное отклонение: 6.36

## Примечания по интеграции

1. В Unity происходит преобразование через `Unity.Barracuda`
2. Входной тензор должен иметь формат [1, height, width, channels] - **но обе модели ожидают формат [1, channels, height, width] (NCHW)**
3. Требуется преобразование форматов тензоров из NHWC (Unity) в NCHW (ONNX)
4. Учитывая динамические размеры входа/выхода для `model.onnx`, нужно быть внимательным при обработке

## Рекомендации

1. Удалить дублирующую копию BiseNet.onnx для экономии места
2. Улучшить обработку ошибок при несоответствии форм тензоров
3. Добавить проверку диапазона индексов при доступе к массиву данных тензора
4. Рассмотреть динамическое переключение между моделями в зависимости от производительности устройства
5. Проверить наличие дополнительной обработки для преобразования NHWC в NCHW и обратно 