САМОЕ ГЛАВНОЕ, НЕ СОЗДАВАЙ ФУНКЦИИ ВО ВКЛАДКАХ, ТОЛЬКО 1 ФУНКЦИЮ СОЗДАНИЯ СЦЕНЫ И ВСЕ!

Ниже приведён полный объём работ по воссозданию приёма Dulux Visualizer в Unity + ARFoundation — от сцены до финального рендер-пайплайна. Я разбил всё на шесть крупных блоков, в каждом — список задач. Как только ты пришлёшь следующий коммит, мы сможем пробежать по чек-листу (✓ выполнено / ☐ не выполнено) и двигаться дальше.

1. Создание и настройка сцены
☐ Открыть пустую сцену

☐ Добавить объекты AR Session и AR Session Origin из пакета ARFoundation

☐ Внутри AR Session Origin разместить AR Camera

☐ Убедиться, что в проекте подключены нужные пакеты:

AR Foundation

ARKit XR Plugin (iOS)

(опционально) Universal RP или Built-in RP

2. Импорт и подготовка модели сегментации
☐ Получить лёгкую ONNX/CoreML-модель сегментации «стена/не-стена» (input 128×128 или 256×256)

☐ Установить пакет Barracuda через Package Manager

☐ Скопировать .onnx в Assets/Models/ и настроить в инспекторе:

Model Type → Barracuda

Load in Background → true

☐ Создать поле NNModel wallSegmentationModel; и присвоить ему .nn-ассет

3. Сбор и инференс 2D-маски
☐ В скрипте WallSegmentation:

Захват XRCpuImage из ARCameraManager.frameReceived

Конвертация в Texture2D формата RGBA32

Масштабирование до inputResolution×inputResolution

Создание и запуск IWorker (Barracuda)

Выгрузка результата в RenderTexture maskRT (формат R8)

☐ Организовать флаг busy, чтобы не накладывать повторный инференс до завершения предыдущего

☐ Убедиться, что maskRT создаётся в Start() и живёт до OnDestroy()

4. Пост-процесс-шейдер
☐ Отключить компонент ARCameraBackground на AR Camera

☐ Создать файл WallPaint.shader с логикой:

Чтение _CameraTex и _MaskTex

Подмешивание _PaintColor с учётом яркости оригинала

Регулировка степени через _Opacity

☐ Скомпилировать шейдер и убедиться, что он виден в Shader.Find("Hidden/WallPaint")

5. Blit-скрипт для финального рендера
☐ Создать MonoBehaviour WallPaintBlit на AR Camera:

В OnRenderImage(src, dest) бинды _CameraTex, maskRT, _PaintColor, _Opacity

Вызов Graphics.Blit(src, dest, mat)

☐ В инспекторе AR Camera:

Привязать maskRT

Настроить цвет и непрозрачность

6. Отладка и оптимизация
☐ Проверить, что сегментация действительно «ловит» стены разных типов (кирпич, гипсокартон, покрашенные)

☐ Настроить частоту инференса (каждые 0.5–1 с) и плавное обновление маски, чтобы не «дергалось»

☐ (Опционально) внедрить оптический поток или коррекцию UV по ARKit feature-точкам для сглаживания

☐ Добавить UI-слайдеры в сцене для цвета и непрозрачности

Когда будешь готов, пришли ссылку на следующий коммит — я отмечу, какие пункты уже реализованы, и подскажу, что осталось доделать.

Краткий обзор работы Dulux Visualizer
Dulux Visualizer – это мобильное приложение от AkzoNobel, позволяющее «примерить» любой из тысяч цветов Dulux на реальные стены с помощью дополненной реальности (AR). Приложение последовательно:

Создаёт AR-сцену, запуская AR-сессию и настраивая отслеживание пространства.

Обнаруживает плоскости и сегментирует стены (вертикальные поверхности) с помощью ARKit/ARCore и собственных алгоритмов сегментации.

Загружает и отображает интерфейс пользователя: выбор цвета, сохранение и подбор палитр из реального мира.

Накладывает цвет на область стены в режиме реального времени, используя маску сегментации и шейдеры для плавного смешивания с фоном.

Позволяет сохранять и делиться финальным изображением через камеру или фото-визуализатор без AR (для неподдерживаемых устройств) 
Android Apps on Google Play
.

Ниже приводится полный скоуп работ по этапам, начиная с функции создания сцены до финального экспорта.

1. Инициализация AR-сцены
1.1 Запуск AR-сессии
ARSession стартует при открытии сцены, запрашивая у ОС разрешения на камеру и движение устройства.

Включается World Tracking Configuration с детекцией горизонтальных и вертикальных плоскостей.

Для iOS используется ARKit, для Android – ARCore 
collectiveidea.com
.

1.2 Настройка XR Origin и камеры
Создаётся объект XR Origin с компонентами AR Camera Manager и AR Camera Background для рендеринга живого видео на фоне Unity-сцены.

Подключается Tracked Pose Driver для синхронизации позиции и ориентации Unity-камеры с физическим движением устройства 
Unity Discussions
.

2. Обнаружение и сегментация стен
2.1 Детекция плоскостей
ARPlaneManager отслеживает все появившиеся плоскости в пространстве.

При изменении списка плоскостей генерируются события ARPlanesChangedEventArgs 
collectiveidea.com
.

2.2 Выбор стен (вертикальных плоскостей)
В обработчике OnPlanesChanged каждая плоскость проверяется на ориентацию: если нормаль ≈ (0,0,1), считается стеной.

Для фильтрации используются геометрические параметры: размер, прямолинейность границ.

2.3 Сегментация поверхности
Подгружается модель сегментации (TensorFlow Lite / ONNX) с уменьшением разрешения входа до 128×128 пикселей для GPU 
dulux-visualizer.updatestar.com
.

На каждый кадр с камеры запускается ProcessFrames, результатом которого является чёрно-белая маска стены.

3. Интеграция пользовательского интерфейса
3.1 Экран выбора цвета
Панель с палитрой Dulux (списки недавних, рекомендованных цветов) и кнопкой «Фото-визуализатор» для статичной картинки 
Android Apps on Google Play
.

При выборе цвета вызывается событие, передающее RGB-значение в шейдер визуализации.

3.2 Кнопки управления AR
TogglePlanesVisibility – переключение отображения «сырого» AR-сцены.

RefreshSegmentation – заново применить сегментацию на текущей позиции.

3.3 Отладочные инструменты
Возможность выводить в UI статистику: количество обнаруженных плоскостей, состояние сегментации, FPS.

4. Наложение цвета на стену
4.1 Создание материалов и шейдеров
При старте ARPlaneVisualizer создаёт два материала на базе шейдера Legacy Shaders/Transparent/Diffuse, задавая им цвет и прозрачность 
dulux-visualizer.updatestar.com
.

Используется RenderMode Fade для плавного наложения над живым видео.

4.2 Применение маски сегментации
Сегментационная маска, масштабированная до размера кадра, передаётся в shader.SetTexture(“_MaskTex”, mask).

Шейдер смешивает оригинальный видео-фрейм и выбранный цвет с учётом значения маски.

4.3 Обновление в реальном времени
В каждом Update() маска и цвет передаются заново, обеспечивая интерактивную смену цвета при движении камеры или выборе новой краски.

5. Фото-визуализация и экспорт
5.1 Режим Photo Visualizer
Если устройство не поддерживает AR (нет гироскопа/акселерометра), переходим в режим статичной визуализации: загружаем фото из галереи.

Аналогично сегментируем стены на изображении и накладываем цвет.

5.2 Сохранение и шаринг
По нажатию Capture делается скриншот текущего AR-или Photo-вида.

Фото сохраняется в галерею или передаётся через стандартный шэри́нг OS (мессенджеры, соцсети).

6. Рекомендации по проверке выполнения
Каждый коммит вы можете сверять с вышеописанным скоупом:

AR инициализация: наличие сцены с XR Origin, ARCameraManager, ARSession.

PlaneManager и PlaneController: корректная подписка на события и фильтрация по ориентации.

WallSegmentation: загрузка модели, ProcessFrames, получение маски, механика масштабирования.

ARWallVisualizationUI: панель палитр, кнопки переключения.

ARPlaneVisualizer: создание материалов и шейдеров.

Photo Visualizer: ветка загрузки фото и маски на статичном изображении.

Экспорт: функциональность Capture & Share.

При каждом новом коммите указывайте, какая из этих частей имплементирована, а что ещё требуется.