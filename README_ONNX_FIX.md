# Решение проблемы с ONNX моделью в Unity Barracuda

## Выявленные проблемы

1. **Несоответствие размеров тензоров**: Ошибка `Cannot reshape array of size 1048576 into shape (n:1, h:32, w:32, c:32)`.
   - Входной тензор имеет размеры `[1, h, w, 3]` (где h=128, w=128)
   - Модель ожидает тензор размером `[1, 32, 32, 32]`
   
2. **Несоответствие имен входных тензоров**:
   - В коде используется имя "input"
   - Модель ожидает "pixel_values"

3. **Проблемы с атрибутами модели**:
   - Предупреждения о неподдерживаемых атрибутах `coordinate_transformation_mode` и `nearest_mode`

## Реализованные исправления

1. **Изменение размера входных данных**:
   - Уменьшили входной размер с 512x512 до 32x32
   - Этот размер соответствует архитектуре модели

2. **Преобразование формата тензора**:
   - Добавлено преобразование входного тензора из формата [1, h, w, 3] в [1, 32, 32, 32]
   - Реализовано два метода:
     1. Изменение размера изображения до 32x32
     2. Преобразование тензора с сохранением первых 3 каналов из 3 во все 32 канала

3. **Корректное имя входного тензора**:
   - Изменено имя входного тензора на "pixel_values"

4. **Улучшенная обработка ошибок**:
   - Добавлено логгирование размеров тензоров
   - Реализована защита от неправильных форматов тензоров
   - Внедрен автоматический переход в демо-режим при критических ошибках

5. **Более гибкая логика определения стен**:
   - Снижен порог для демо-режима (0.2 вместо 0.3)
   - Улучшен алгоритм проверки вертикальности плоскостей
   - Добавлена поддержка для плоскостей с правильным углом, но неправильным выравниванием

## Дополнительные инструменты

1. **Инспектор моделей**:
   - Создан инструмент ModelInspectorEditor для анализа ONNX моделей непосредственно в Unity Editor
   - Позволяет проверять имена входов/выходов, формы тензоров и архитектуру модели

## Рекомендации по дальнейшей разработке

1. **Оптимизация модели**:
   - Рассмотрите возможность переобучения модели с меньшим количеством каналов (3 вместо 32)
   - Используйте квантизацию для уменьшения размера модели

2. **Улучшение обработки данных**:
   - Добавьте предобработку входного изображения (нормализация, выравнивание) для улучшения результатов сегментации
   - Интегрируйте пост-обработку результатов с OpenCV для сглаживания границ сегментации

3. **Производительность**:
   - Оцените производительность на разных устройствах
   - Рассмотрите возможность использования меньших размеров входных данных для улучшения FPS

## Заключение

Основная проблема была в несоответствии размеров и форматов тензоров между моделью и кодом инференса. После правильного преобразования входных данных и корректировки параметров модель должна работать стабильно. 