# План работ по разработке системы сегментации и перекраски стен

## Фаза 1: Базовый прототип сегментации и перекраски
- [x] Анализ существующего кода WallSegmentation.cs
- [x] Обновление ML фреймворка с Barracuda на Sentis
- [x] Выбор оптимальной модели сегментации (YOLOv8n-seg или MobileUNet)
- [x] Настройка экспорта модели в ONNX формат
- [x] Реализация подготовки входных данных для модели
- [x] Обработка выходного тензора для генерации маски сегментации
- [x] Создание базового шейдера для перекраски стен (найден существующий WallPaint.shader)

## Фаза 2: Интеграция AR и оптимизация
- [x] Настройка AR Foundation камеры и сессии (уже реализовано в WallSegmentation.cs)
- [x] Усовершенствование шейдера перекраски с сохранением текстуры (HSL/YIQ) (реализовано в WallPaint.shader)
- [x] Реализация URP ScriptableRendererFeature для эффекта перекраски (имеется WallPaintBlit.cs)
- [x] Оптимизация обработки тензоров на GPU
- [x] Асинхронная обработка для поддержания стабильного FPS (имеется ProcessImageAsync в WallSegmentation.cs)
- [x] Интерфейс выбора цвета (имеется по ссылкам на класс UIController)

## Фаза 3: Продвинутые улучшения
- [x] Стабилизация маски сегментации (временное сглаживание) (имеется InterpolateSegmentationResults в WallSegmentation.cs)
- [ ] Интеграция оценки освещения AR Foundation
- [ ] Улучшенное взаимодействие с ARMeshManager для детализированного освещения (для устройств с LiDAR)
- [ ] Сбор данных и дообучение модели сегментации (если потребуется)
- [ ] Оптимизация под различные устройства

## Фаза 4: Документация и интеграция
- [x] Создание README с описанием компонентов и инструкциями по настройке
- [x] Документация для настройки и использования SentisWallSegmentation
- [ ] Интеграция с UI для выбора цвета
- [x] Создание демо-сцены с готовой настройкой всех компонентов

## Тестирование и оценка
- [ ] Измерение точности сегментации (mIoU)
- [ ] Анализ производительности (FPS, время инференса)
- [ ] Оценка задержки перекраски
- [ ] Субъективная оценка визуального качества
- [ ] Проверка стабильности маски

## Текущий статус:
1. Проведен анализ существующего кода WallSegmentation.cs:
   - Класс использует Unity Barracuda для инференса нейронных сетей
   - Поддерживает разные режимы работы: Demo, EmbeddedModel, ExternalModel
   - Имеет встроенный механизм стабилизации маски через временное сглаживание
   - Создает RenderTexture с маской сегментации для внешнего использования
   - Работает с ARFoundation для получения изображения с камеры

2. Обнаружены существующие компоненты для перекраски:
   - WallPaint.shader - шейдер с поддержкой сохранения текстуры и теней
   - WallPaintBlit.cs - компонент для применения эффекта перекраски
   - ImprovedWallPaint.shader - улучшенная версия шейдера перекраски

3. Создан новый компонент SentisWallSegmentation.cs:
   - Полностью переписана логика инференса модели с использованием Unity Sentis вместо Barracuda
   - Реализовано автоматическое определение формата тензоров (NCHW/NHWC)
   - Добавлена поддержка различных типов моделей (YOLOv8, MobileNet)
   - Улучшена стабилизация результатов сегментации через буферизацию и интерполяцию
   - Добавлены дополнительные методы для взаимодействия с компонентом
   - Сохранена обратная совместимость интерфейса с исходным WallSegmentation.cs

4. Создана документация:
   - Файл README.md с описанием компонентов системы
   - Инструкции по установке и настройке компонентов
   - Описание настройки моделей и рекомендации по устранению неполадок
   - Примеры кода для использования компонентов

5. Реализована демо-сцена:
   - Создан скрипт SentisWallSegmentationDemo для автоматической настройки компонентов
   - Создан скрипт DemoSceneCreator для генерации полной демо-сцены
   - Добавлен инструмент в меню редактора для быстрого создания тестовой сцены
   - Включена поддержка переключения режимов работы и изменения цвета перекраски в реальном времени
   - Добавлен отладочный интерфейс для визуализации маски сегментации

6. Подготовлена интеграция модели YOLOv8n-seg:
   - Создан скрипт YOLOv8ModelPreparation с детальными инструкциями по экспорту модели
   - Разработан шаблон Python-скрипта для конвертации модели в ONNX формат
   - Предоставлен пример C# кода для интеграции YOLOv8n-seg с Unity Sentis
   - Добавлены ссылки на готовые модели и ресурсы для дальнейшей работы
   - Предоставлены инструкции по настройке параметров SentisWallSegmentation

7. Следующие задачи:
   - Тестирование SentisWallSegmentation с YOLOv8n-seg на устройствах Android/iOS
   - Доработка алгоритма обработки выходных данных YOLOv8n-seg в SentisWallSegmentation
   - Улучшение взаимодействия с освещением в AR для более реалистичной перекраски стен
   - Разработка промежуточного представления данных для повышения производительности на мобильных устройствах 