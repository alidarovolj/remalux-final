# Решение проблемы интеграции ONNX модели в Unity с использованием Barracuda

## Исходная проблема

Проект AR-приложения для покраски стен с использованием Unity и OpenCV столкнулся с несколькими проблемами при интеграции ONNX модели сегментации стен через Barracuda:

1. Дублирование полей в WallSegmentation.cs
2. Ошибки связанные с несоответствием типов и параметров модели ONNX
3. Отсутствие обработки преобразования формата тензора из NHWC (Unity) в NCHW (ONNX)
4. Несоответствие количества каналов (32 вместо 3 RGB)
5. Ошибка CS1503 при конструировании Tensor из массива float[]

## Проведенный анализ

Для анализа проблемы были выполнены следующие шаги:

1. Создан скрипт `inspect_onnx_rt.py` для анализа ONNX моделей
2. Проанализированы модели в проекте:
   - `model.onnx` (14 МБ) - 150 классов, динамический размер входа
   - `BiseNet.onnx` (46 МБ) - 12 классов, фиксированный размер входа 720x960

3. Выявлены несоответствия:
   - Настройки входных каналов (32 вместо 3)
   - Неправильные имена входных и выходных тензоров для BiseNet.onnx
   - Несоответствие формата тензоров между Unity (NHWC) и ONNX (NCHW)
   - Некорректный индекс класса стены (9) для model.onnx

## Реализованные исправления

1. **Исправлены дублирования полей в WallSegmentation.cs**:
   - Удалены повторяющиеся определения полей
   - Оставлены только одни определения параметров с улучшенными комментариями

2. **Исправлены параметры модели**:
   - Количество каналов изменено с 32 на 3 (RGB)
   - Добавлены комментарии о правильных именах тензоров для BiseNet.onnx

3. **Исправлен метод RunModelSegmentation**:
   - Добавлен комментарий о различии форматов NHWC и NCHW
   - Исправлен вызов конструктора Tensor с использованием правильной сигнатуры
   - Улучшена обработка ошибок

4. **Добавлен метод CreateSegmentationTexture**:
   - Реализовано корректное преобразование выходного тензора в текстуру
   - Учтены возможные различия в размерах входного и выходного тензора
   - Добавлено масштабирование результата

5. **Составлен отчет с рекомендациями**:
   - Рекомендовано использовать BiseNet.onnx для сегментации стен
   - Указаны правильные параметры и имена тензоров для модели
   - Предложены оптимизации для более эффективной работы

## Результаты

- Успешно скомпилирован проект без ошибок компиляции
- Исправлены основные проблемы с несоответствием параметров между Unity и ONNX моделями
- Улучшена обработка ошибок и диагностика проблем с моделью
- Создана документация по результатам анализа ONNX моделей (README_ONNX_INFO.md)

## Дальнейшие рекомендации

1. Удалить дублирующуюся копию BiseNet.onnx для экономии места
2. Рассмотреть возможность перехода на BiseNet.onnx для лучшей сегментации стен
3. При использовании BiseNet.onnx обновить имена тензоров и размеры входа
4. Добавить дополнительные проверки диапазона индексов при работе с тензорами
5. Реализовать динамическое переключение между моделями в зависимости от производительности устройства 